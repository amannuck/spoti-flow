let t=[];chrome.storage.local.get(["spotifyTabs"],e=>{e.spotifyTabs&&(t=e.spotifyTabs,a())});async function a(){const e=[];for(const r of t)try{const o=await chrome.tabs.get(r);o&&o.url&&o.url.includes("open.spotify.com")&&e.push(r)}catch{console.log("Tab no longer exists:",r)}t=e,chrome.storage.local.set({spotifyTabs:t})}chrome.tabs.onUpdated.addListener((e,r,o)=>{o.url&&o.url.includes("open.spotify.com")&&r.status==="complete"&&(t.includes(e)||(t.push(e),chrome.storage.local.set({spotifyTabs:t}),console.log("Spotify tab detected:",e)),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).catch(console.error))});chrome.tabs.onRemoved.addListener(e=>{const r=t.indexOf(e);r>-1&&(t.splice(r,1),chrome.storage.local.set({spotifyTabs:t}),console.log("Spotify tab closed:",e))});setInterval(a,5*60*1e3);chrome.runtime.onMessage.addListener((e,r,o)=>{if(e.action==="getSpotifyTabs")return a().then(()=>{o({tabs:t})}),!0;if(e.action==="control"&&e.command){const{command:c}=e;return t.length>0?(chrome.tabs.sendMessage(t[0],{action:"control",command:c}).then(()=>o({success:!0})).catch(i=>{console.error("Error sending command:",i),o({success:!1,error:"Failed to send command"})}),!0):(o({success:!1,error:"No Spotify tabs found"}),!0)}if(e.action==="getTrackInfo")return t.length>0?(chrome.tabs.sendMessage(t[0],{action:"getTrackInfo"}).then(c=>o(c)).catch(c=>{console.error("Error getting track info:",c),o({success:!1,error:"Failed to get track info"})}),!0):(o({success:!1,error:"No Spotify tabs found"}),!0);if(e.action==="openMiniPlayer")return t.length>0?(chrome.tabs.sendMessage(t[0],{action:"openMiniPlayer"}).then(c=>o(c)).catch(c=>{console.error("Error opening mini player:",c),o({success:!1,error:"Failed to open mini player"})}),!0):(o({success:!1,error:"No Spotify tabs found"}),!0)});
